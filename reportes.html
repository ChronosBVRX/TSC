<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Reportes</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-100">
<main class="max-w-5xl mx-auto p-4 space-y-4">
  <section class="rounded-2xl border border-slate-800/70 bg-slate-900/60 p-4">
    <h2 class="text-sm font-semibold mb-2">Resumen del día</h2>
    <div id="head" class="text-xs text-slate-300"></div>
    <div class="mt-3 grid grid-cols-3 gap-3 text-center">
      <div class="rounded-lg border border-slate-800 p-3">
        <div class="text-[11px] text-slate-400">Viajes</div>
        <div id="k-viajes" class="text-xl font-bold">0</div>
      </div>
      <div class="rounded-lg border border-slate-800 p-3">
        <div class="text-[11px] text-slate-400">VINS</div>
        <div id="k-vins" class="text-xl font-bold">0</div>
      </div>
      <div class="rounded-lg border border-slate-800 p-3">
        <div class="text-[11px] text-slate-400">Pendientes</div>
        <div id="k-pend" class="text-xl font-bold">0</div>
      </div>
    </div>
    <div class="mt-3 flex gap-2">
      <a id="btn-ir-operacion" href="operacion.html" target="_blank" class="px-3 py-2 text-xs rounded-lg border border-slate-700">Editar datos</a>
      <button id="btn-exportar" class="px-3 py-2 text-xs rounded-lg border border-slate-700">Exportar CSV</button>
      <button id="btn-imagen" class="px-3 py-2 text-xs rounded-lg bg-emerald-600 hover:bg-emerald-500 font-semibold">Generar PNG (abrirá Operación)</button>
    </div>
  </section>

  <section class="rounded-2xl border border-slate-800/70 bg-slate-900/60 p-4">
    <h3 class="text-sm font-semibold mb-2">Detalle</h3>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="bg-slate-800 text-slate-300">
            <th class="px-3 py-2 text-left">Eco</th>
            <th class="px-3 py-2">VINS</th>
            <th class="px-3 py-2">Viaje</th>
            <th class="px-3 py-2 text-left">Status</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </div>
  </section>
</main>

<script>
  function load(){ const raw=localStorage.getItem('tsc_monitor'); return raw?JSON.parse(raw):null }
  function esc(s){return String(s??'')}
  function csv(d){
    const rows=[['Eco','N° de VINS','N° Viaje','Status']];
    d.ops.forEach(r=>rows.push([r.eco,r.vins,r.viaje,r.status]));
    rows.push(['Programming',d.ops.reduce((a,b)=>a+(b.vins||0),0),d.ops.length,'']);
    rows.push([]); rows.push(['Viajes a subir a sistema']); rows.push(['Eco','N° Viaje']);
    (d.pend||[]).forEach(r=>rows.push([r.eco,r.viaje]));
    return rows.map(r=>r.map(x=>`"${String(x??'').replaceAll('"','""')}"`).join(',')).join('\n');
  }
  (function init(){
    const d=load(); if(!d){document.getElementById('head').textContent='No hay datos guardados.'; return}
    document.getElementById('head').textContent=`Cliente: ${d.header?.cliente||'-'} · Buque: ${d.header?.buque||'-'} · Fecha: ${d.header?.fecha||'-'}`;
    document.getElementById('k-viajes').textContent=d.ops?.length||0;
    document.getElementById('k-vins').textContent=(d.ops||[]).reduce((a,b)=>a+(b.vins||0),0);
    document.getElementById('k-pend').textContent=d.pend?.length||0;

    const tb=document.getElementById('tb'); tb.innerHTML='';
    (d.ops||[]).forEach(r=>{
      const tr=document.createElement('tr'); tr.className='border-b border-slate-800';
      tr.innerHTML=`<td class="px-3 py-2">${esc(r.eco)}</td>
      <td class="px-3 py-2 text-center">${r.vins??''}</td>
      <td class="px-3 py-2 text-center">${esc(r.viaje)}</td>
      <td class="px-3 py-2">${esc(r.status)}</td>`;
      tb.appendChild(tr);
    });

    document.getElementById('btn-exportar').onclick=()=>{
      const blob=new Blob([csv(d)],{type:'text/csv'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download=`TSC_Programming_${d.header?.fecha||'fecha'}.csv`; a.click();
      setTimeout(()=>URL.revokeObjectURL(url),4000);
    };
    document.getElementById('btn-imagen').onclick=()=>{ window.open('operacion.html#autoPNG','_blank'); };
  })();
</script>
</body>
</html>