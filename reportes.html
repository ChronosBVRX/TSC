<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Reportes</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-100">
<main class="max-w-5xl mx-auto p-4 space-y-4">
  <section class="rounded-2xl border border-slate-800/70 bg-slate-900/60 p-4">
    <h2 class="text-sm font-semibold mb-2">Resumen del día</h2>
    <div id="head" class="text-xs text-slate-300"></div>
    <div class="mt-3 grid grid-cols-3 gap-3 text-center">
      <div class="rounded-lg border border-slate-800 p-3">
        <div class="text-[11px] text-slate-400">Viajes</div>
        <div id="k-viajes" class="text-xl font-bold">0</div>
      </div>
      <div class="rounded-lg border border-slate-800 p-3">
        <div class="text-[11px] text-slate-400">VINS</div>
        <div id="k-vins" class="text-xl font-bold">0</div>
      </div>
      <div class="rounded-lg border border-slate-800 p-3">
        <div class="text-[11px] text-slate-400">Transportista</div>
        <div id="k-trans" class="text-xl font-bold">-</div>
      </div>
    </div>
    <div class="mt-3 flex gap-2">
      <a href="operacion.html" target="_blank" class="px-3 py-2 text-xs rounded-lg border border-slate-700">Editar datos</a>
      <button id="btn-exportar" class="px-3 py-2 text-xs rounded-lg border border-slate-700">Exportar CSV</button>
      <button id="btn-imagen" class="px-3 py-2 text-xs rounded-lg bg-emerald-600 hover:bg-emerald-500 font-semibold">Generar PNG (abre Activas)</button>
    </div>
  </section>

  <section class="rounded-2xl border border-slate-800/70 bg-slate-900/60 p-4">
    <h3 class="text-sm font-semibold mb-2">Detalle</h3>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="bg-slate-800 text-slate-300">
            <th class="px-3 py-2 text-left">Eco</th>
            <th class="px-3 py-2">VINS</th>
            <th class="px-3 py-2">Viaje</th>
            <th class="px-3 py-2 text-left">Status</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </div>
  </section>
</main>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://xugajqlyvojqeciawpzj.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh1Z2FqcWx5dm9qcWVjaWF3cHpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NjM4MzksImV4cCI6MjA3NzMzOTgzOX0.tt2_6zqf9R0cGO6Fenx_FJO6sAg6jM_CYY1Peuq6Qyo";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function loadHeader(){ const {data}=await sb.from('header').select('*').eq('id','dia').maybeSingle(); return data||{}; }
  async function loadOps(){ const {data}=await sb.from('ops_active').select('*').order('created_at',{ascending:true}); return data||[]; }

  (async function init(){
    const h=await loadHeader(); const ops=await loadOps();
    document.getElementById('head').textContent=`Cliente: ${h.cliente||'-'} · Buque: ${h.buque||'-'} · Fecha: ${h.fecha||'-'} · Transportista: ${h.transportista||'-'}`;
    document.getElementById('k-viajes').textContent=ops.length;
    document.getElementById('k-vins').textContent=ops.reduce((a,b)=>a+(b.vins||0),0);
    document.getElementById('k-trans').textContent=h.transportista||'-';

    const tb=document.getElementById('tb'); tb.innerHTML='';
    ops.forEach(r=>{
      const tr=document.createElement('tr'); tr.className='border-b border-slate-800';
      tr.innerHTML=`<td class="px-3 py-2">${r.eco}</td>
      <td class="px-3 py-2 text-center">${r.vins??''}</td>
      <td class="px-3 py-2 text-center">${r.viaje}</td>
      <td class="px-3 py-2">${r.status}</td>`;
      tb.appendChild(tr);
    });

    document.getElementById('btn-exportar').onclick=()=>{
      const rows=[
        ['LOGO_IZQUIERDO','TSC'], ['LOGO_DERECHO', h.transportista || ''],
        [], ['Eco','N° de VINS','N° Viaje','Status']
      ];
      ops.forEach(r=>rows.push([r.eco,r.vins,r.viaje,r.status]));
      rows.push(['Programming', ops.reduce((a,b)=>a+(b.vins||0),0), ops.length, '']);
      const csv=rows.map(r=>r.map(x=>`"${String(x??'').replaceAll('"','""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`TSC_Programming_${h.fecha||'fecha'}.csv`; a.click();
      setTimeout(()=>URL.revokeObjectURL(url),4000);
    };
    document.getElementById('btn-imagen').onclick=()=> window.open('activas.html','_blank');
  })();
</script>
</body>
</html>
