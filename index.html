<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Operación del día – Altas (Madrinas · Nacionales · Contenedores)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body{
    background:
      radial-gradient(1200px 800px at 8% -10%, rgba(34,211,238,.08) 0%, transparent 60%),
      radial-gradient(900px 700px at 100% 0%, rgba(139,92,246,.08) 0%, transparent 55%),
      linear-gradient(180deg,#0a0f1a 0%,#06080f 100%);
    color:#e5e7eb;
  }
  .card{background:rgba(15,23,41,.7);border:1px solid #1f2a44;border-radius:16px}
  .tabs button[aria-selected="true"]{background:#0f172a;border-color:#22d3ee;color:#e6faff}
  .in{background:#0b1324;border:1px solid #1b2742;border-radius:10px;padding:.6rem .8rem}
  .in:focus{outline:none;border-color:#22d3ee;box-shadow:0 0 0 2px rgba(34,211,238,.15)}
  label>span{font-size:.72rem;color:#cbd5e1}
  .grid-5{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:.75rem}
  .grid-4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:.75rem}
  .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:.75rem}
  @media (max-width:1024px){.grid-5,.grid-4,.grid-3{grid-template-columns:1fr}}
</style>
</head>
<body class="min-h-screen">

<main class="max-w-5xl mx-auto p-4 space-y-4">

  <!-- Encabezado del día -->
  <section class="card p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-sm font-semibold">Encabezado del día</h2>
      <span id="chip-tipo" class="text-[11px] px-2 py-1 rounded bg-cyan-600/20 border border-cyan-600/40 text-cyan-200">
        Alta para: <b id="chip-tipo-txt">MADRINAS</b>
      </span>
    </div>

    <div class="grid-3">
      <label class="grid gap-1"><span>Cliente</span>
        <input id="cliente" class="in" value="FORD"/>
      </label>
      <label class="grid gap-1"><span>Buque</span>
        <input id="buque" class="in" placeholder="LAPIS ARROW"/>
      </label>
      <label class="grid gap-1"><span>Fecha</span>
        <input id="fecha" type="date" class="in"/>
      </label>
    </div>

    <!-- Logos -->
    <div class="mt-3 grid-3 items-end">
      <div class="text-xs">
        <div class="mb-1">Logo izquierdo (fijo)</div>
        <div class="flex items-center gap-2">
          <img id="prev-left" class="h-10 rounded border border-slate-700" alt="TSC">
          <span class="text-[11px] text-slate-400">TSC siempre va a la izquierda</span>
        </div>
      </div>

      <label class="grid gap-1 text-xs">
        <span>Logo derecho (transportista)</span>
        <select id="transportista" class="in">
          <option value="">— Ninguno —</option>
          <option value="HADRON">HADRON</option>
          <option value="RAPIDOS">RÁPIDOS</option>
        </select>
      </label>

      <div class="text-xs">
        <div class="mb-1">Vista previa (derecha)</div>
        <img id="prev-right" class="h-10 rounded border border-slate-700" alt="Transportista" style="display:none">
      </div>
    </div>

    <p class="mt-2 text-[11px] text-slate-400">
      El logo de TSC se coloca a la izquierda. A la derecha irá el transportista elegido (HADRON o RÁPIDOS). Si no eliges, no se mostrará.
    </p>
  </section>

  <!-- Tabs -->
  <section class="card p-2">
    <div class="tabs flex gap-2 p-2">
      <button class="px-3 py-2 text-xs rounded border border-slate-700" data-tab="madrinas" aria-selected="true">Madrinas</button>
      <button class="px-3 py-2 text-xs rounded border border-slate-700" data-tab="nacionales">Nacionales</button>
      <button class="px-3 py-2 text-xs rounded border border-slate-700" data-tab="contenedores">Contenedores</button>
    </div>

    <!-- MADRINAS -->
    <div id="tab-madrinas" class="p-4 space-y-3">
      <h3 class="text-sm font-semibold">Agregar operación – Madrinas</h3>
      <div class="grid-5">
        <label class="grid gap-1"><span>Eco</span>
          <input id="m-eco" class="in" placeholder="17017 / M1"/>
        </label>
        <label class="grid gap-1"><span>N° de VINS</span>
          <input id="m-vins" type="number" value="9" min="0" class="in"/>
        </label>
        <label class="grid gap-1"><span>N° de Viaje</span>
          <input id="m-viaje" class="in" placeholder="MED-01"/>
        </label>
        <label class="grid gap-1"><span>Status</span>
          <select id="m-status" class="in">
            <option>TRAYECTO A ASLA</option>
            <option>EN TERMINAL PROCESO DE CARGA</option>
            <option>SALIENDO DE TERMINAL CARGADO</option>
            <option>CARGADO EN RUTA FISCAL</option>
            <option>POR MODULAR</option>
            <option>TRAYECTO A PATIO DE DESCARGA</option>
            <option>DESCARGADO 100%</option>
            <option>1ER VUELTA</option>
            <option>2DA VUELTA</option>
            <option>3ER VUELTA</option>
            <option>4TA VUELTA</option>
            <option>5TA VUELTA</option>
            <option>EN PATIO EN PROCESO DE DESCARGA</option>
            <option>EN TRAYECTO A PATIO DE RESGUARDO</option>
            <option>CARGADO EN PATIO DE RESGUARDO</option>
            <option>TRAYECTO A TERMINAL</option>
            <option>REGISTRADO EN ESPERA DE LLAMADO</option>
            <option>EN TERMINAL EN ESPERA DE CARGA EN ASLA</option>
          </select>
        </label>
        <div class="flex items-end">
          <button class="w-full rounded-lg bg-cyan-600 hover:bg-cyan-500 px-3 py-2 text-xs font-semibold" id="btn-m">Agregar</button>
        </div>
      </div>
      <p id="msg-m" class="text-xs text-emerald-300 hidden">Operación agregada a <b>Madrinas</b>.</p>
    </div>

    <!-- NACIONALES -->
    <div id="tab-nacionales" class="p-4 space-y-3 hidden">
      <h3 class="text-sm font-semibold">Agregar operación – Nacionales</h3>
      <div class="grid-5">
        <label class="grid gap-1"><span>Eco</span>
          <input id="n-eco" class="in" placeholder="Económico"/>
        </label>
        <label class="grid gap-1"><span>Operador</span>
          <input id="n-operador" class="in" placeholder="Nombre del operador"/>
        </label>
        <label class="grid gap-1"><span>Teléfono</span>
          <input id="n-telefono" class="in" placeholder="753 000 0000"/>
        </label>
        <label class="grid gap-1"><span>Status</span>
          <select id="n-status" class="in">
            <option>EN ORIGEN</option>
            <option>CARGANDO</option>
            <option>EN TRÁNSITO</option>
            <option>DESCARGANDO</option>
            <option>ENTREGADO</option>
            <option>INCIDENCIA</option>
          </select>
        </label>
        <div class="flex items-end">
          <button class="w-full rounded-lg bg-cyan-600 hover:bg-cyan-500 px-3 py-2 text-xs font-semibold" id="btn-n">Agregar</button>
        </div>
      </div>
      <p class="text-[11px] text-slate-400">* Si después quieres más campos para Nacionales (origen, destino, producto, etc.), los agregamos.</p>
      <p id="msg-n" class="text-xs text-emerald-300 hidden">Operación agregada a <b>Nacionales</b>.</p>
    </div>

    <!-- CONTENEDORES -->
    <div id="tab-contenedores" class="p-4 space-y-3 hidden">
      <h3 class="text-sm font-semibold">Agregar operación – Contenedores</h3>
      <div class="grid-4">
        <label class="grid gap-1"><span>Transporte</span>
          <input id="c-transporte" class="in" placeholder="TSC / Proveedor"/>
        </label>
        <label class="grid gap-1"><span>Operador</span>
          <input id="c-operador" class="in" placeholder="OSVALDO LEAL"/>
        </label>
        <label class="grid gap-1"><span>Teléfono</span>
          <input id="c-telefono" class="in" placeholder="753 157 8649"/>
        </label>
        <label class="grid gap-1"><span>Económico</span>
          <input id="c-economico" class="in" placeholder="17019"/>
        </label>
      </div>

      <div class="grid-4">
        <label class="grid gap-1"><span>Placa</span>
          <input id="c-placa" class="in" placeholder="NS7248C"/>
        </label>
        <label class="grid gap-1"><span>No. Contenedor</span>
          <input id="c-contenedor" class="in" placeholder="BMOU5567200 / ILLU4519583"/>
        </label>
        <label class="grid gap-1"><span>Terminal</span>
          <input id="c-terminal" class="in" placeholder="LCPTC / APM / SSA"/>
        </label>
        <label class="grid gap-1"><span>Status</span>
          <select id="c-status" class="in">
            <option>REGISTRADO EN ESPERA DE LLAMADO</option>
            <option>ASIGNADO PARA ENTRADA</option>
            <option>EN FILA DE ACCESO</option>
            <option>DENTRO DE TERMINAL</option>
            <option>SALIENDO DE TERMINAL</option>
            <option>EN TRÁNSITO</option>
            <option>ENTREGADO</option>
            <option>INCIDENCIA</option>
          </select>
        </label>
      </div>

      <div class="flex justify-end">
        <button class="rounded-lg bg-cyan-600 hover:bg-cyan-500 px-3 py-2 text-xs font-semibold" id="btn-c">Agregar</button>
      </div>
      <p id="msg-c" class="text-xs text-emerald-300 hidden">Operación agregada a <b>Contenedores</b>.</p>
    </div>
  </section>

  <div class="flex gap-2">
    <a href="activas.html" class="px-3 py-2 text-xs rounded-lg border border-slate-700">Ir a Activas</a>
  </div>
</main>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  // ========= SUPABASE =========
  const SUPABASE_URL = "https://xugajqlyvojqeciawpzj.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh1Z2FqcWx5dm9qcWVjaWF3cHpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NjM4MzksImV4cCI6MjA3NzMzOTgzOX0.tt2_6zqf9R0cGO6Fenx_FJO6sAg6jM_CYY1Peuq6Qyo";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* Estructuras sugeridas en Supabase:
  -- header(id text pk, cliente text, buque text, fecha date, transportista text, logo_right_url text)
  -- ops_active(id bigserial pk, tipo text, eco text, vins int, viaje text, status text, created_at timestamptz default now())
  -- ops_nacionales(id bigserial pk, cliente text, fecha date, eco text, operador text, telefono text, status text, created_at timestamptz default now())
  -- ops_contenedores(id bigserial pk, cliente text, fecha date, transporte text, operador text, telefono text, economico text, placa text, contenedor text, terminal text, status text, created_at timestamptz default now())
  */

  // ========= LOGOS =========
  const LOGO_LEFT_TSC = "https://raw.githubusercontent.com/ChronosBVRX/TSC/main/Imagen%20de%20WhatsApp%202025-10-29%20a%20las%2013.29.51_292c634c.jpg";
  const LOGO_RIGHT = {
    "": "",
    "HADRON": "https://raw.githubusercontent.com/ChronosBVRX/TSC/main/hadron.jpg",
    "RAPIDOS": "https://raw.githubusercontent.com/ChronosBVRX/TSC/main/RAPIDOS-DE-MICHOACAN-1.jpg"
  };

  const $ = s => document.querySelector(s);
  const byId = id => document.getElementById(id);

  // ========= INIT =========
  (async ()=>{
    byId('fecha').value = new Date().toISOString().slice(0,10);
    byId('prev-left').src = LOGO_LEFT_TSC;

    const h = await dbLoadHeader();
    if(h){
      byId('cliente').value = h.cliente || '';
      byId('buque').value   = h.buque || '';
      byId('fecha').value   = h.fecha || byId('fecha').value;
      byId('transportista').value = h.transportista || '';
    }
    updateRightPreview();

    // eventos
    $('#transportista').addEventListener('change', updateRightPreview);
    document.querySelectorAll('.tabs button').forEach(btn=>{
      btn.addEventListener('click',()=>switchTab(btn.dataset.tab));
    });

    // botones de alta
    byId('btn-m').addEventListener('click', addMadrina);
    byId('btn-n').addEventListener('click', addNacional);
    byId('btn-c').addEventListener('click', addContenedor);
  })();

  function switchTab(tab){
    // visual
    document.querySelectorAll('.tabs button').forEach(b=>{
      b.setAttribute('aria-selected', String(b.dataset.tab===tab));
    });
    ['madrinas','nacionales','contenedores'].forEach(t=>{
      byId('tab-'+t).classList.toggle('hidden', t!==tab);
    });
    // chip
    const map = {madrinas:'MADRINAS', nacionales:'NACIONALES', contenedores:'CONTENEDORES'};
    byId('chip-tipo-txt').textContent = map[tab];
  }

  function updateRightPreview() {
    const sel = byId('transportista').value || '';
    const url = LOGO_RIGHT[sel] || '';
    const img = byId('prev-right');
    if (url) {
      img.src = url;
      img.style.display = 'block';
    } else {
      img.src = '';
      img.style.display = 'none';
    }
  }

  // ========= DB helpers =========
  async function dbLoadHeader(){
    const { data, error } = await sb.from('header').select('*').eq('id','dia').maybeSingle();
    if(error && error.code!=='PGRST116') console.error(error);
    return data || null;
  }
  async function dbSaveHeader(){
    const transportista = byId('transportista').value || '';
    const logo_right_url = LOGO_RIGHT[transportista] || '';
    const payload = {
      id:'dia',
      cliente: byId('cliente').value,
      buque: byId('buque').value,
      fecha: byId('fecha').value,
      transportista, logo_right_url
    };
    const { error } = await sb.from('header').upsert(payload);
    if(error) console.error(error);
  }

  // ========= ALTAS =========
  async function addMadrina(){
    const eco   = byId('m-eco').value.trim();
    const vins  = parseInt(byId('m-vins').value||'0',10);
    const viaje = byId('m-viaje').value.trim();
    const status= byId('m-status').value;

    if(!eco || !viaje){ alert('Eco y N° de Viaje son obligatorios'); return; }

    await dbSaveHeader();

    const { error } = await sb.from('ops_active').insert({
      tipo:'MADRINAS', eco, vins, viaje, status
    });
    if(error){ alert('Error al guardar (Madrinas): '+error.message); return; }

    byId('m-eco').value=''; byId('m-viaje').value='';
    showMsg('msg-m');
  }

  async function addNacional(){
    const eco = byId('n-eco').value.trim();
    const operador = byId('n-operador').value.trim();
    const telefono = byId('n-telefono').value.trim();
    const status = byId('n-status').value;

    if(!eco){ alert('Eco es obligatorio'); return; }

    await dbSaveHeader();

    const { error } = await sb.from('ops_nacionales').insert({
      cliente: byId('cliente').value,
      fecha: byId('fecha').value,
      eco, operador, telefono, status
    });
    if(error){ alert('Error al guardar (Nacionales): '+error.message); return; }

    byId('n-eco').value=''; byId('n-operador').value=''; byId('n-telefono').value='';
    showMsg('msg-n');
  }

  async function addContenedor(){
    const transporte = byId('c-transporte').value.trim();
    const operador   = byId('c-operador').value.trim();
    const telefono   = byId('c-telefono').value.trim();
    const economico  = byId('c-economico').value.trim();
    const placa      = byId('c-placa').value.trim();
    const contenedor = byId('c-contenedor').value.trim();
    const terminal   = byId('c-terminal').value.trim();
    const status     = byId('c-status').value;

    if(!transporte || !contenedor){ alert('Transporte y No. Contenedor son obligatorios'); return; }

    await dbSaveHeader();

    const { error } = await sb.from('ops_contenedores').insert({
      cliente: byId('cliente').value,
      fecha: byId('fecha').value,
      transporte, operador, telefono, economico, placa, contenedor, terminal, status
    });
    if(error){ alert('Error al guardar (Contenedores): '+error.message); return; }

    ['c-transporte','c-operador','c-telefono','c-economico','c-placa','c-contenedor','c-terminal'].forEach(id=>byId(id).value='');
    showMsg('msg-c');
  }

  function showMsg(id){
    const el = byId(id);
    el.classList.remove('hidden');
    setTimeout(()=>el.classList.add('hidden'),1800);
  }
</script>
</body>
</html>
