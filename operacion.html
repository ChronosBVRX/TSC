<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Operación del día – Alta</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-100">
<main class="max-w-3xl mx-auto p-4 space-y-4">

  <section class="rounded-2xl border border-slate-800/70 bg-slate-900/60 p-4">
    <h2 class="text-sm font-semibold mb-3">Encabezado del día</h2>
    <div class="grid md:grid-cols-3 gap-3">
      <label class="text-xs grid gap-1"><span>Cliente</span><input id="cliente" class="px-3 py-2 rounded-lg bg-slate-900 border border-slate-700" value="FORD"/></label>
      <label class="text-xs grid gap-1"><span>Buque</span><input id="buque" class="px-3 py-2 rounded-lg bg-slate-900 border border-slate-700" placeholder="LAPIS ARROW"/></label>
      <label class="text-xs grid gap-1"><span>Fecha</span><input id="fecha" type="date" class="px-3 py-2 rounded-lg bg-slate-900 border border-slate-700"/></label>
    </div>
    <p class="mt-2 text-[11px] text-slate-400">Este encabezado se usará en el reporte (PNG/CSV) desde la pestaña <b>Activas</b>.</p>
  </section>

  <section class="rounded-2xl border border-slate-800/70 bg-slate-900/60 p-4">
    <h2 class="text-sm font-semibold mb-3">Agregar operación</h2>
    <div class="grid md:grid-cols-5 gap-3">
      <label class="text-xs grid gap-1"><span>Eco</span><input id="eco" class="px-3 py-2 rounded-lg bg-slate-900 border border-slate-700" placeholder="17017 / M1"/></label>
      <label class="text-xs grid gap-1"><span>N° de VINS</span><input id="vins" type="number" value="9" min="0" class="px-3 py-2 rounded-lg bg-slate-900 border border-slate-700"/></label>
      <label class="text-xs grid gap-1"><span>N° de Viaje</span><input id="viaje" class="px-3 py-2 rounded-lg bg-slate-900 border border-slate-700" placeholder="MED-01"/></label>
      <label class="text-xs grid gap-1"><span>Status</span>
        <select id="status" class="px-3 py-2 rounded-lg bg-slate-900 border border-slate-700">
          <option>TRAYECTO A ASLA</option>
          <option>EN TERMINAL PROCESO DE CARGA</option>
          <option>SALIENDO DE TERMINAL CARGADO</option>
          <option>CARGADO EN RUTA FISCAL</option>
          <option>POR MODULAR</option>
          <option>TRAYECTO A PATIO DE DESCARGA</option>
          <option>DESCARGADO 100%</option>
          <option>1ER VUELTA</option>
          <option>2DA VUELTA</option>
          <option>3ER VUELTA</option>
          <option>4TA VUELTA</option>
          <option>5TA VUELTA</option>
          <option>EN PATIO EN PROCESO DE DESCARGA</option>
          <option>EN TRAYECTO A PATIO DE RESGUARDO</option>
          <option>CARGADO EN PATIO DE RESGUARDO</option>
          <option>TRAYECTO A TERMINAL</option>
          <option>REGISTRADO EN ESPERA DE LLAMADO</option>
          <option>EN TERMINAL EN ESPERA DE CARGA EN ASLA</option>
        </select>
      </label>
      <div class="flex items-end">
        <button class="w-full rounded-lg bg-cyan-600 hover:bg-cyan-500 px-3 py-2 text-xs font-semibold" onclick="addOp()">Agregar</button>
      </div>
    </div>

    <div id="last-msg" class="mt-3 text-xs text-emerald-300 hidden">Operación agregada a <b>Activas</b>.</div>
    <div class="mt-3 flex gap-2">
      <a href="activas.html" class="px-3 py-2 text-xs rounded-lg border border-slate-700">Ir a Activas</a>
    </div>
  </section>
</main>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  // === SUPABASE (tus datos) ===
  const SUPABASE_URL = "https://xugajqlyvojqeciawpzj.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh1Z2FqcWx5dm9qcWVjaWF3cHpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NjM4MzksImV4cCI6MjA3NzMzOTgzOX0.tt2_6zqf9R0cGO6Fenx_FJO6sAg6jM_CYY1Peuq6Qyo";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const byId=id=>document.getElementById(id);

  (async ()=>{
    byId('fecha').value=new Date().toISOString().slice(0,10);
    const h = await dbLoadHeader();
    if(h){ byId('cliente').value=h.cliente||''; byId('buque').value=h.buque||''; byId('fecha').value=h.fecha||byId('fecha').value; }
  })();

  async function dbLoadHeader(){
    const { data, error } = await sb.from('header').select('*').eq('id','dia').maybeSingle();
    if(error && error.code!=='PGRST116') console.error(error);
    return data || null;
  }
  async function dbSaveHeader(h){
    const { error } = await sb.from('header').upsert({ id:'dia', ...h });
    if(error) console.error(error);
  }
  async function dbAddOp(op){
    const { error } = await sb.from('ops_active').insert(op);
    if(error) alert('Error al guardar: '+error.message);
  }

  async function addOp(){
    const eco=byId('eco').value.trim(),
          vins=parseInt(byId('vins').value||'0',10),
          viaje=byId('viaje').value.trim(),
          status=byId('status').value;
    if(!eco||!viaje){ alert('Eco y N° de Viaje son obligatorios'); return; }

    await dbSaveHeader({
      cliente: byId('cliente').value,
      buque: byId('buque').value,
      fecha: byId('fecha').value
    });

    await dbAddOp({ eco, vins, viaje, status });

    byId('eco').value=''; byId('viaje').value='';
    const msg=byId('last-msg'); msg.classList.remove('hidden'); setTimeout(()=>msg.classList.add('hidden'), 1800);
  }
</script>
</body>
</html>
