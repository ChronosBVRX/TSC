<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Operación del día – Activas</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{ --bg:#05070b; --panel:#0b1220; --edge:#101826; --txt:#c7d2fe; --cyan:#22d3ee; --vio:#8b5cf6; --rose:#fb7185; }
  body{
    color:#e5e7eb;
    background:
      radial-gradient(1200px 800px at 10% 0%,#0b1220 0%,transparent 60%),
      radial-gradient(800px 600px at 90% 10%,#0a1630 0%,transparent 55%),
      linear-gradient(180deg,#05070b 0%,#070b12 60%,#05070b 100%);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }
  .card{border:1px solid #0f1b2e;background:linear-gradient(180deg,#0b1220 0%, #0a1323 100%),rgba(0,0,0,.4);
        box-shadow:0 0 0 1px rgba(34,211,238,.15) inset, 0 0 32px rgba(34,211,238,.06); border-radius:16px}
  .tabs button[aria-selected="true"]{background:#0f172a;border-color:#22d3ee;color:#e6faff}
  .in{border:1px solid #1f2a40;background:#0e1423;border-radius:.75rem;padding:.6rem .8rem;outline:none}
  .in:focus{box-shadow:0 0 0 2px rgba(34,211,238,.35)}
  label>span{font-size:.72rem;color:#cbd5e1}
  .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:.75rem}
  @media (max-width:1024px){.grid-3{grid-template-columns:1fr}}
  .table th{font-size:.72rem;text-transform:uppercase;letter-spacing:.02em}
  .table th,.table td{white-space:nowrap;padding:.55rem .7rem;border-bottom:1px solid #1c2845}
  .table tr:hover td{background:rgba(34,211,238,.05)}
  tfoot td{background:rgba(34,211,238,.06);font-weight:600}
</style>
</head>
<body class="min-h-screen">
<main class="max-w-6xl mx-auto p-4 space-y-4">

  <!-- Encabezado (logos + datos del día) -->
  <section class="card p-4">
    <div class="flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <img id="logo-left" class="h-12 w-12 rounded-xl ring-1 ring-cyan-400/40 bg-cyan-500/20"
             src="https://raw.githubusercontent.com/ChronosBVRX/TSC/main/Imagen%20de%20WhatsApp%202025-10-29%20a%20las%2013.29.51_292c634c.jpg" alt="TSC">
        <div>
          <div class="text-sm font-semibold">PROGRAMMING OF THE DAY</div>
          <div class="text-[12px] text-slate-300">
            Cliente: <b id="h-cliente">—</b> · Buque: <b id="h-buque">—</b> · Fecha: <b id="h-fecha">—</b>
          </div>
        </div>
      </div>
      <img id="logo-right" class="h-12 rounded border border-slate-700" alt="Transportista" style="display:none">
    </div>
  </section>

  <!-- Controles -->
  <section class="card p-2">
    <div class="flex flex-wrap items-center justify-between gap-2 p-2">
      <div class="tabs flex gap-2">
        <button class="px-3 py-2 text-xs rounded border border-slate-700" data-tab="madrinas" aria-selected="true">Madrinas</button>
        <button class="px-3 py-2 text-xs rounded border border-slate-700" data-tab="nacionales">Nacionales</button>
        <button class="px-3 py-2 text-xs rounded border border-slate-700" data-tab="contenedores">Contenedores</button>
      </div>
      <div class="flex items-center gap-2">
        <a href="operacion.html" class="px-3 py-2 text-xs rounded border border-slate-700">← Altas</a>
        <button id="btn-export" class="px-3 py-2 text-xs rounded bg-cyan-600 hover:bg-cyan-500">Exportar CSV</button>
      </div>
    </div>

    <div class="p-3 grid-3">
      <label class="grid gap-1"><span>Fecha (del registro)</span>
        <input id="f-fecha" type="date" class="in">
      </label>
      <label class="grid gap-1"><span>Status</span>
        <select id="f-status" class="in">
          <option value="">— Todos —</option>
        </select>
      </label>
      <label class="grid gap-1"><span>Búsqueda rápida</span>
        <input id="f-q" class="in" placeholder="Eco, operador, contenedor, placa…">
      </label>
    </div>
  </section>

  <!-- Tabla -->
  <section class="card p-4">
    <div class="mb-2 text-[12px] text-slate-300">
      Mostrando: <b id="lbl-tipo">Madrinas</b> · Coincidencias: <b id="lbl-count">0</b>
    </div>
    <div class="overflow-auto">
      <table class="table w-full text-sm">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
        <tfoot id="tfoot"></tfoot>
      </table>
    </div>
  </section>

</main>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  // ====== SUPABASE ======
  const sb = supabase.createClient(
    "https://xugajqlyvojqeciawpzj.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh1Z2FqcWx5dm9qcWVjaWF3cHpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NjM4MzksImV4cCI6MjA3NzMzOTgzOX0.tt2_6zqf9R0cGO6Fenx_FJO6sAg6jM_CYY1Peuq6Qyo"
  );

  // ====== ESTADO UI ======
  const $ = s => document.querySelector(s);
  const thead = $('#thead'), tbody = $('#tbody'), tfoot = $('#tfoot');
  const lblTipo = $('#lbl-tipo'), lblCount = $('#lbl-count');

  let header = {};
  let tab = 'madrinas';
  let dataRaw = [], dataFiltered = [];

  // ====== COLUMNAS POR TIPO ======
  const COLS = {
    madrinas: [
      { key:'eco',      name:'Eco' },
      { key:'vins',     name:'VINS' },
      { key:'viaje',    name:'N° Viaje' },
      { key:'status',   name:'Status' },
      { key:'created_at', name:'Creado', fmt:v=>v?new Date(v).toLocaleString():'' }
    ],
    nacionales: [
      { key:'economico',   name:'Económico' },
      { key:'placa',       name:'Placa' },
      { key:'operador',    name:'Operador' },
      { key:'asignacion',  name:'Asignación', fmt:v=>v||'' },
      { key:'no_viaje',    name:'N° Viaje' },
      { key:'dealer',      name:'Dealer' },
      { key:'origen',      name:'Origen' },
      { key:'destino',     name:'Destino' },
      { key:'ubicacion',   name:'Ubicación' },
      { key:'status',      name:'Status' },
      { key:'inicio_ruta', name:'Inicio ruta',    fmt:v=>v?new Date(v).toLocaleString():'' },
      { key:'llegada_destino', name:'Llegada destino', fmt:v=>v?new Date(v).toLocaleString():'' },
      { key:'created_at',  name:'Creado', fmt:v=>v?new Date(v).toLocaleString():'' }
    ],
    contenedores: [
      { key:'transporte', name:'Transporte' },
      { key:'operador',   name:'Operador' },
      { key:'telefono',   name:'Teléfono' },
      { key:'economico',  name:'Económico' },
      { key:'placa',      name:'Placa' },
      { key:'contenedor', name:'No. Contenedor' },
      { key:'terminal',   name:'Terminal' },
      { key:'status',     name:'Status' },
      { key:'created_at', name:'Creado', fmt:v=>v?new Date(v).toLocaleString():'' }
    ]
  };

  // ====== INICIO ======
  (async ()=>{
    await loadHeader();
    setHeaderUI();

    document.querySelectorAll('.tabs button').forEach(b=>{
      b.addEventListener('click', async ()=>{
        document.querySelectorAll('.tabs button').forEach(x=>x.setAttribute('aria-selected','false'));
        b.setAttribute('aria-selected','true');
        tab = b.dataset.tab;
        lblTipo.textContent = cap(tab);
        $('#f-status').innerHTML = '<option value="">— Todos —</option>'; // reset status list
        await loadTab();
      });
    });

    // filtros + export
    $('#f-q').addEventListener('input', applyFilters);
    $('#f-status').addEventListener('change', applyFilters);
    $('#f-fecha').addEventListener('change', applyFilters);
    $('#btn-export').addEventListener('click', exportCSV);

    await loadTab();
  })();

  function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

  async function loadHeader(){
    const { data, error } = await sb.from('header').select('*').eq('id','dia').maybeSingle();
    if(error && error.code!=='PGRST116') console.error(error);
    header = data || {};
    if(header?.fecha) $('#f-fecha').value = header.fecha;
  }

  function setHeaderUI(){
    $('#h-cliente').textContent = header?.cliente || '—';
    $('#h-buque').textContent   = header?.buque   || '—';
    $('#h-fecha').textContent   = header?.fecha   || '—';

    const lr = $('#logo-right');
    if(header?.logo_right_url){ lr.src = header.logo_right_url; lr.style.display='block'; }
    else{ lr.src=''; lr.style.display='none'; }
  }

  async function loadTab(){
    renderHead(COLS[tab]);

    let query;
    if(tab==='madrinas'){
      query = sb.from('ops_active').select('*').eq('tipo','MADRINAS').order('created_at',{ascending:false});
    }else if(tab==='nacionales'){
      query = sb.from('ops_nacionales').select('*').order('created_at',{ascending:false});
    }else{
      query = sb.from('ops_contenedores').select('*').order('created_at',{ascending:false});
    }

    const { data, error } = await query;
    if(error){ console.error(error); dataRaw = []; }
    else { dataRaw = data || []; }

    buildStatusOptions(dataRaw);
    applyFilters(true);
  }

  function renderHead(cols){
    thead.innerHTML = '';
    const tr = document.createElement('tr');
    cols.forEach(c=>{
      const th = document.createElement('th');
      th.textContent = c.name;
      th.className = "text-left text-slate-200";
      tr.appendChild(th);
    });
    thead.appendChild(tr);
  }

  function buildStatusOptions(rows){
    const set = new Set();
    rows.forEach(r=>{ if(r.status) set.add(r.status); });
    const sel = $('#f-status'); sel.innerHTML = '<option value="">— Todos —</option>';
    Array.from(set).sort().forEach(v=>{
      const op=document.createElement('option'); op.value=v; op.textContent=v; sel.appendChild(op);
    });
  }

  function applyFilters(){
    const q = $('#f-q').value.trim().toLowerCase();
    const st = $('#f-status').value;
    const fDate = $('#f-fecha').value;

    const cols = COLS[tab];

    dataFiltered = dataRaw.filter(row=>{
      const passDate = !fDate || (row.fecha ? String(row.fecha) === fDate : true);
      const passSt   = !st || row.status === st;
      const passQ    = !q || cols.some(c=>{
        const val = row[c.key];
        return (val!==undefined && val!==null && String(val).toLowerCase().includes(q));
      });
      return passDate && passSt && passQ;
    });

    renderBody(dataFiltered, cols);
    renderFoot(dataFiltered, cols);
    lblCount.textContent = dataFiltered.length;
  }

  function renderBody(rows, cols){
    tbody.innerHTML = '';
    if(rows.length===0){
      const tr=document.createElement('tr');
      const td=document.createElement('td');
      td.colSpan=cols.length; td.className="py-6 text-center text-slate-400";
      td.textContent="Sin registros para los filtros aplicados.";
      tr.appendChild(td); tbody.appendChild(tr); return;
    }
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      cols.forEach(c=>{
        const td=document.createElement('td');
        const v=r[c.key];
        td.textContent=c.fmt?c.fmt(v):(v??'');
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  function renderFoot(rows, cols){
    tfoot.innerHTML='';
    if(rows.length===0) return;

    // Totales simples: Madrinas suma VINS; todos cuentan filas
    const tr=document.createElement('tr');
    const td=document.createElement('td');
    td.colSpan=cols.length;
    let extra='';
    if(tab==='madrinas'){
      const sumVins = rows.reduce((a,b)=>a + (parseInt(b.vins||0,10)||0), 0);
      extra = ` · VINS: ${sumVins}`;
    }
    td.textContent = `Registros: ${rows.length}${extra}`;
    tr.appendChild(td); tfoot.appendChild(tr);
  }

  function exportCSV(){
    const cols = COLS[tab];
    const headerRow = cols.map(c=>`"${c.name.replace(/"/g,'""')}"`).join(',');
    const bodyRows = dataFiltered.map(r=>{
      return cols.map(c=>{
        const raw = c.fmt ? c.fmt(r[c.key]) : (r[c.key] ?? '');
        const cell = String(raw).replace(/"/g,'""');
        return `"${cell}"`;
      }).join(',');
    }).join('\n');

    const csv = headerRow + '\n' + bodyRows;
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const d = (header?.fecha || new Date().toISOString().slice(0,10));
    const fn = `${cap(tab)}_${d}.csv`;
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fn;
    document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
  }
</script>
</body>
</html>
