<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Operaciones Activas</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
  .sheet{width:980px;background:#fff;color:#111827;border:1px solid #d1d5db;border-radius:6px;padding:14px;margin:auto}
  .sheet .top{display:grid;grid-template-columns:1fr auto 1fr;align-items:center}
  .sheet img.logo{height:58px;object-fit:contain}
  .sheet h1{font-size:18px;margin:0;font-weight:800;text-align:center}
  .sheet .meta{margin-top:6px;border:1px solid #d1d5db;padding:6px 10px;font-size:14px}
  .sheet table{width:100%;border-collapse:collapse;margin-top:8px}
  .sheet th,.sheet td{border:1px solid #d1d5db;padding:6px 8px;font-size:14px}
  .sheet th{background:#eef2f7;text-align:center}
  .status-ok{color:#065f46;font-weight:700}
  .status-2v{color:#7a3b00;font-weight:700}
  .totals td{background:#e8eef7;font-weight:700}
</style>
</head>
<body class="bg-slate-950 text-slate-100">
<main class="max-w-6xl mx-auto p-4 space-y-4">

  <section class="rounded-2xl border border-slate-800/70 bg-slate-900/60 p-4">
    <div id="head" class="text-sm"></div>
    <div class="mt-3 flex flex-wrap gap-2">
      <button class="px-3 py-2 text-xs rounded-lg border border-slate-700" onclick="exportCSV()">Exportar CSV</button>
      <button class="px-3 py-2 text-xs rounded-lg bg-emerald-600 hover:bg-emerald-500 font-semibold" onclick="makePNG()">Generar PNG</button>
      <a href="operacion.html" class="px-3 py-2 text-xs rounded-lg border border-slate-700">Agregar más</a>
      <button class="px-3 py-2 text-xs rounded-lg border border-rose-700 text-rose-300" onclick="vaciar()">Vaciar Activas</button>
    </div>
  </section>

  <section class="rounded-2xl border border-slate-800/70 bg-slate-900/60 p-4">
    <h2 class="text-sm font-semibold mb-2">Operaciones activas</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="bg-slate-800 text-slate-300">
            <th class="px-3 py-2 text-left">Eco</th>
            <th class="px-3 py-2">VINS</th>
            <th class="px-3 py-2">Viaje</th>
            <th class="px-3 py-2 text-left">Status</th>
            <th class="px-3 py-2">Terminar</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
        <tfoot>
          <tr class="border-t border-slate-800">
            <th class="px-3 py-2 text-left">Totales</th>
            <th id="k-vins" class="px-3 py-2 text-center">0</th>
            <th id="k-viajes" class="px-3 py-2 text-center">0</th>
            <th class="px-3 py-2" colspan="2"></th>
          </tr>
        </tfoot>
      </table>
    </div>
  </section>

  <section class="rounded-2xl border border-slate-800/70 bg-slate-900/60 p-4">
    <h3 class="text-sm font-semibold mb-2">Vista previa del reporte</h3>
    <div id="sheet" class="sheet">
      <div class="top">
        <img id="imgLeft" class="logo" alt="Logo TSC">
        <h1>PROGRAMMING OF THE DAY</h1>
        <img id="imgRight" class="logo" alt="Logo Transportista">
      </div>
      <div class="meta">
        <div><b>Cliente:</b> <span id="metaCliente">-</span> &nbsp;&nbsp; <b>Buque:</b> <span id="metaBuque">-</span></div>
        <div><b>Date:</b> <span id="metaFecha">-</span> &nbsp;&nbsp; <b>Transportista:</b> <span id="metaTrans">-</span></div>
      </div>
      <table>
        <thead><tr><th>Eco</th><th>N° de VINS</th><th>N° Viaje</th><th>Status</th></tr></thead>
        <tbody id="sheetBody"></tbody>
        <tfoot><tr class="totals"><td><b>Programming</b></td><td id="sTotalVins">0</td><td id="sTotalViajes">0</td><td></td></tr></tfoot>
      </table>
    </div>
  </section>
</main>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  // SUPABASE
  const SUPABASE_URL = "https://xugajqlyvojqeciawpzj.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh1Z2FqcWx5dm9qcWVjaWF3cHpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NjM4MzksImV4cCI6MjA3NzMzOTgzOX0.tt2_6zqf9R0cGO6Fenx_FJO6sAg6jM_CYY1Peuq6Qyo";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Logos RAW
  const LOGO_LEFT_TSC = "https://raw.githubusercontent.com/ChronosBVRX/TSC/main/Imagen%20de%20WhatsApp%202025-10-29%20a%20las%2013.29.51_292c634c.jpg";
  const FALLBACK_TRANSPORT = ""; // si no hay transportista
  const $=s=>document.querySelector(s), byId=id=>document.getElementById(id);

  const STATUS_LIST=[
    "TRAYECTO A ASLA","EN TERMINAL PROCESO DE CARGA","SALIENDO DE TERMINAL CARGADO",
    "CARGADO EN RUTA FISCAL","POR MODULAR","TRAYECTO A PATIO DE DESCARGA","DESCARGADO 100%",
    "1ER VUELTA","2DA VUELTA","3ER VUELTA","4TA VUELTA","5TA VUELTA",
    "EN PATIO EN PROCESO DE DESCARGA","EN TRAYECTO A PATIO DE RESGUARDO","CARGADO EN PATIO DE RESGUARDO",
    "TRAYECTO A TERMINAL","REGISTRADO EN ESPERA DE LLAMADO","EN TERMINAL EN ESPERA DE CARGA EN ASLA"
  ];

  function esc(s){return String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
  function statusClass(s){ s=String(s||'').toUpperCase(); if(s.includes('DESCARGADO 100%')) return 'status-ok'; if(s.includes('VUELTA')) return 'status-2v'; return ''; }

  async function dbLoadHeader(){
    const { data, error } = await sb.from('header').select('*').eq('id','dia').maybeSingle();
    if(error && error.code!=='PGRST116') console.error(error);
    return data || {};
  }
  async function dbLoadActive(){
    const { data, error } = await sb.from('ops_active').select('*').order('created_at',{ascending:true});
    if(error){ console.error(error); return [] }
    return data || [];
  }
  async function dbUpdateStatus(id, status){ await sb.from('ops_active').update({ status }).eq('id', id); }
  async function dbDeleteOp(id){ await sb.from('ops_active').delete().eq('id', id); }
  async function dbClearAll(){ await sb.from('ops_active').delete().neq('id','00000000-0000-0000-0000-000000000000'); }

  async function render(){
    const h = await dbLoadHeader();
    const ops = await dbLoadActive();

    // Encabezado y logos
    byId('head').innerHTML=`Cliente: <b>${esc(h.cliente||'-')}</b> · Buque: <b>${esc(h.buque||'-')}</b> · Fecha: <b>${esc(h.fecha||'-')}</b> · Transportista: <b>${esc(h.transportista||'-')}</b>`;
    byId('metaCliente').textContent=h.cliente||'-';
    byId('metaBuque').textContent=h.buque||'-';
    byId('metaFecha').textContent=h.fecha||'-';
    byId('metaTrans').textContent=h.transportista||'-';
    byId('imgLeft').src = LOGO_LEFT_TSC;
    byId('imgRight').src = h.logo_right_url || FALLBACK_TRANSPORT;

    // Tabla
    const tb=byId('tb'); tb.innerHTML='';
    let tv=0,tr=ops.length;
    ops.forEach((r)=>{
      tv+=r.vins||0;
      const trEl=document.createElement('tr'); trEl.className='border-b border-slate-800';
      trEl.innerHTML=`<td class="px-3 py-2">${esc(r.eco)}</td>
        <td class="px-3 py-2 text-center">${r.vins??''}</td>
        <td class="px-3 py-2 text-center">${esc(r.viaje)}</td>
        <td class="px-3 py-2">${statusSelect(r.status,r.id)}</td>
        <td class="px-3 py-2 text-center"><button class="text-rose-300 text-xs border border-rose-700 px-2 py-1 rounded" onclick="terminar('${r.id}')">Terminar</button></td>`;
      tb.appendChild(trEl);
    });
    byId('k-vins').textContent=tv; byId('k-viajes').textContent=tr;

    // Sheet (PNG)
    const sbdy=byId('sheetBody'); sbdy.innerHTML='';
    ops.forEach(r=>{
      const row=document.createElement('tr');
      row.innerHTML=`<td>${esc(r.eco)}</td><td style="text-align:center">${r.vins??''}</td><td style="text-align:center">${esc(r.viaje)}</td><td class="${statusClass(r.status)}">${esc(r.status)}</td>`;
      sbdy.appendChild(row);
    });
    byId('sTotalVins').textContent=tv; byId('sTotalViajes').textContent=tr;
  }

  function statusSelect(value, id){
    const opts=STATUS_LIST.map(s=>`<option ${s===value?'selected':''}>${s}</option>`).join('');
    return `<select class="px-2 py-1 rounded bg-slate-900 border border-slate-700 text-xs" onchange="updateStatus('${id}', this.value)">${opts}</select>`;
  }

  async function updateStatus(id, value){ await dbUpdateStatus(id, value); }
  async function terminar(id){ await dbDeleteOp(id); }
  async function vaciar(){ if(confirm('¿Vaciar todas las activas?')) await dbClearAll(); }

  // CSV: agrego línea con info de logos (texto)
  function exportCSV(){
    (async ()=>{
      const h=await dbLoadHeader(); const ops=await dbLoadActive();
      const rows=[
        ['LOGO_IZQUIERDO','TSC'], ['LOGO_DERECHO', h.transportista || ''],
        [], ['Eco','N° de VINS','N° Viaje','Status']
      ];
      ops.forEach(r=>rows.push([r.eco,r.vins,r.viaje,r.status]));
      rows.push(['Programming', ops.reduce((a,b)=>a+(b.vins||0),0), ops.length, '']);
      const csv=rows.map(r=>r.map(x=>`"${String(x??'').replaceAll('"','""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`TSC_Programming_${h.fecha||'fecha'}.csv`; a.click();
      setTimeout(()=>URL.revokeObjectURL(url),4000);
    })();
  }

  async function makePNG(){
    const canvas=await html2canvas(document.getElementById('sheet'),{scale:2,backgroundColor:'#ffffff'});
    const url=canvas.toDataURL('image/png'); const h=await dbLoadHeader();
    const a=document.createElement('a'); a.href=url; a.download=`TSC_Programming_${h.fecha||'fecha'}.png`; a.click();
  }

  render();
  const channel = sb.channel('ops_active-realtime')
    .on('postgres_changes', { event:'*', schema:'public', table:'ops_active' }, () => render())
    .subscribe();
</script>
</body>
</html>
